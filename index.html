<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ AI Agent â€” í•­ê³µÂ·í˜¸í…” ì¶”ì²œ</title>
  <meta name="description" content="ìì—°ì–´ ìš”ì²­ ê¸°ë°˜ í•­ê³µ/í˜¸í…” ê²€ìƒ‰ Â· ìµœì €ê°€/ìµœë‹¨ì‹œê°„/ìµœì €í™˜ìŠ¹ ì¶”ì²œ Â· ëª¨ì˜ ê²°ì œ" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{ @apply bg-white border border-gray-200 rounded-2xl p-4 shadow-sm; }
    .pill{ @apply border border-gray-200 bg-gray-50 rounded-xl p-3; }
    .badge{ @apply text-xs px-2 py-0.5 rounded-full; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <!-- í—¤ë” -->
    <header class="mb-6 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold">ì—¬í–‰ AI Agent</h1>
        <p class="text-gray-600">ìì—°ì–´ë¡œ ìš”ì²­í•˜ê³ , <b>ìµœì €ê°€ Â· ìµœë‹¨ì‹œê°„ Â· ìµœì €í™˜ìŠ¹</b> 3ê°€ì§€ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤</p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="w-80 px-3 py-2 border rounded-lg"
               placeholder="https://<your-vercel>.vercel.app/api" />
      </div>
    </header>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <section class="card">
      <div class="mb-2 font-semibold">ìì—°ì–´ ìš”ì²­</div>
      <textarea id="query" rows="3" class="w-full p-3 border rounded-xl"
        placeholder="ì˜ˆ) ì¸ì²œì—ì„œ ë„ì¿„ ì™•ë³µ, 11ì›” 2ì¼ ì¶œë°œ 11ì›” 4ì¼ ê·€êµ­, ë„ì¿„ 2ë°•, ì„±ì¸ 2ëª…">ì¸ì²œì—ì„œ ë„ì¿„ ì™•ë³µ, 10ì›” 3ì¼ ì¶œë°œ 10ì›” 5ì¼ ê·€êµ­, ë„ì¿„ 2ë°•, ì„±ì¸ 2ëª…</textarea>

      <div class="mt-3 flex items-center gap-3">
        <button id="btnSearch" class="px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">ê²€ìƒ‰ ì‹¤í–‰</button>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>

      <details class="mt-3">
        <summary class="cursor-pointer text-sm text-gray-500">íŒŒì‹± ê²°ê³¼ ë³´ê¸°</summary>
        <pre id="parsedBox" class="mt-2 text-xs text-gray-700 bg-gray-100 p-3 rounded-lg overflow-auto"></pre>
      </details>

      <div id="error" class="mt-3 text-red-600 text-sm hidden"></div>
    </section>

    <!-- ì¶”ì²œ ì¹´ë“œ -->
    <section id="recommend" class="grid md:grid-cols-3 gap-4 mt-6"></section>

    <!-- í›„ë³´ ë¦¬ìŠ¤íŠ¸ (ê²€ì¦ìš©) -->
    <section id="lists" class="card mt-6 hidden">
      <details open>
        <summary class="font-semibold">í›„ë³´ ë¦¬ìŠ¤íŠ¸(ê²€ì¦ìš©)</summary>
        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div>
            <div class="font-semibold">í•­ê³µ í›„ë³´</div>
            <div id="flightList" class="mt-2 space-y-2 max-h-96 overflow-auto"></div>
          </div>
          <div>
            <div class="font-semibold">í˜¸í…” í›„ë³´</div>
            <div id="hotelList" class="mt-2 space-y-2 max-h-96 overflow-auto"></div>
          </div>
        </div>
      </details>
    </section>
  </div>

  <!-- ëª¨ì˜ ê²°ì œ ëª¨ë‹¬ -->
  <div id="payModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
    <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
      <h3 class="text-xl font-bold mb-3">ëª¨ì˜ ê²°ì œ</h3>
      <div id="paySummary" class="pill text-sm mb-3"></div>

      <div class="grid gap-3">
        <input id="payName" class="px-3 py-2 border rounded-lg" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" />
        <input id="payEmail" class="px-3 py-2 border rounded-lg" placeholder="ì´ë©”ì¼ (ì˜ˆ: user@example.com)" />
        <input id="payCard" class="px-3 py-2 border rounded-lg" placeholder="ì¹´ë“œë²ˆí˜¸ (ëª¨ì˜: 4111-1111-1111-1111)" />
      </div>

      <div class="flex gap-2 mt-4">
        <button id="btnPay" class="flex-1 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">ê²°ì œí•˜ê¸°</button>
        <button id="btnCancel" class="flex-1 px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">ì·¨ì†Œ</button>
      </div>
      <p id="payMsg" class="text-sm text-gray-600 mt-3"></p>
    </div>
  </div>

  <script>
    // ====== ì„¤ì • ======
    const $ = (sel) => document.querySelector(sel);
    const KRW = (n) => Number(n||0).toLocaleString('ko-KR');
    const toISO = (d) => new Date(d).toISOString().slice(0,10);
    const minutesToHM = (m)=>`${Math.floor(m/60)}ì‹œê°„ ${m%60}ë¶„`;
    const cityForAirport=(c)=>({HND:'TYO',NRT:'TYO',GMP:'SEL',ICN:'SEL'})[c]||c;

    // ====== ê°„ë‹¨ ìì—°ì–´ íŒŒì„œ (í”„ë¡ íŠ¸ í´ë°±) ======
    function parseNatural(textRaw){
      const t=(textRaw||'').trim();
      const origin=/ê¹€í¬/.test(t)?'GMP':'ICN';
      const destination=/ë‚˜ë¦¬íƒ€/.test(t)?'NRT':/í•˜ë„¤ë‹¤|ë„ì¿„/.test(t)?'HND':'HND';
      const adults=(t.match(/(ì„±ì¸|ì–´ë¥¸|adults?)\s*(\d+)/i)?.[2]||1)|0;
      const nights=(t.match(/(\d+)\s*ë°•/)?.[1]||2)|0;

      const Y=new Date().getFullYear();
      const parseK=(s)=>{
        if(!s) return null;
        const a=s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
        const b=s.match(/(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼/);
        const c=s.match(/(\d{1,2})[./-](\d{1,2})/);
        if(a) return new Date(+a[1],+a[2]-1,+a[3]);
        if(b) return new Date(Y,+b[1]-1,+b[2]);
        if(c) return new Date(Y,+c[1]-1,+c[2]);
        return null;
      };

      let departDate=null, returnDate=null;
      const pair=t.match(/(\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼|\d{4}-\d{2}-\d{2}|\d{1,2}[./-]\d{1,2}).{0,8}?(ê·€êµ­|ë¦¬í„´|ëŒì•„|~|ë¶€í„°|ì¶œë°œ).{0,12}?(\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼|\d{4}-\d{2}-\d{2}|\d{1,2}[./-]\d{1,2})/);
      if(pair){ departDate=parseK(pair[1]); returnDate=parseK(pair[3]); }
      if(!departDate){
        const dep=t.match(/(\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼|\d{4}-\d{2}-\d{2}|\d{1,2}[./-]\d{1,2}).{0,3}ì¶œë°œ/);
        if(dep) departDate=parseK(dep[1]);
      }
      if(!returnDate && departDate){
        const ret=t.match(/(\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼|\d{4}-\d{2}-\d{2}|\d{1,2}[./-]\d{1,2}).{0,3}(ê·€êµ­|ë³µê·€|ë¦¬í„´|ëŒì•„)/);
        if(ret) returnDate=parseK(ret[1]);
      }
      if(!departDate || !returnDate){
        const now=new Date(), dow=now.getDay();
        const add=((5-dow+7)%7)||7; // ë‹¤ìŒ ê¸ˆìš”ì¼
        departDate=new Date(now); departDate.setDate(now.getDate()+add);
        returnDate=new Date(departDate); returnDate.setDate(departDate.getDate()+Math.max(1,nights||2));
      }
      return { origin, destination, departDate, returnDate, nights: nights||2, adults: adults||1, destinationCity: cityForAirport(destination) };
    }

    // ====== Mock ë°ì´í„° (API ì‹¤íŒ¨ ì‹œ í´ë°±) ======
    function mockFlights(p){ return [
      { id:"F1", airline:{code:"KE", name:"ëŒ€í•œí•­ê³µ"}, origin:p.origin, destination:p.destination, departDate:toISO(p.departDate), returnDate:toISO(p.returnDate), departTime:"08:10", returnTime:"19:25", duration:140, stops:0, ontime:95, baggageIncluded:1, price:220000*p.adults },
      { id:"F2", airline:{code:"JL", name:"JAL"},       origin:p.origin, destination:p.destination, departDate:toISO(p.departDate), returnDate:toISO(p.returnDate), departTime:"11:40", returnTime:"21:05", duration:155, stops:0, ontime:93, baggageIncluded:1, price:205000*p.adults },
      { id:"F3", airline:{code:"NH", name:"ANA"},       origin:p.origin, destination:p.destination, departDate:toISO(p.departDate), returnDate:toISO(p.returnDate), departTime:"07:25", returnTime:"18:40", duration:310, stops:1, ontime:90, baggageIncluded:0, price:170000*p.adults },
      { id:"F4", airline:{code:"7C", name:"ì œì£¼í•­ê³µ"},  origin:p.origin, destination:p.destination, departDate:toISO(p.departDate), returnDate:toISO(p.returnDate), departTime:"15:00", returnTime:"20:30", duration:150, stops:0, ontime:88, baggageIncluded:0, price:160000*p.adults },
      { id:"F5", airline:{code:"TW", name:"í‹°ì›¨ì´"},     origin:p.origin, destination:p.destination, departDate:toISO(p.departDate), returnDate:toISO(p.returnDate), departTime:"18:10", returnTime:"22:05", duration:145, stops:0, ontime:91, baggageIncluded:0, price:150000*p.adults },
    ];}
    function mockHotels(p){ return [
      { id:"H1", name:"ì‹ ì£¼ì¿  ìŠ¤í…Œì´", area:"ì‹ ì£¼ì¿ ", stars:4.5, rating:4.6, reviews:1320, refundable:true,  checkIn:toISO(p.departDate), checkOut:toISO(p.returnDate), nights:p.nights, pricePerNight:120000, taxesPerNight:15000 },
      { id:"H2", name:"ê¸´ì í”„ë¦¬ë¯¸ì–´", area:"ê¸´ì", stars:5.0, rating:4.8, reviews:980,  refundable:false, checkIn:toISO(p.departDate), checkOut:toISO(p.returnDate), nights:p.nights, pricePerNight:190000, taxesPerNight:22000 },
      { id:"H3", name:"ì•„ì‚¬ì¿ ì‚¬ ë¦¬ë²„", area:"ì•„ì‚¬ì¿ ì‚¬", stars:3.8, rating:4.3, reviews:740,  refundable:true,  checkIn:toISO(p.departDate), checkOut:toISO(p.returnDate), nights:p.nights, pricePerNight:90000,  taxesPerNight:12000 },
      { id:"H4", name:"í•˜ë„¤ë‹¤ ê³µí•­ í˜¸í…”", area:"ì˜¤íƒ€êµ¬", stars:3.6, rating:4.1, reviews:510,  refundable:true,  checkIn:toISO(p.departDate), checkOut:toISO(p.returnDate), nights:p.nights, pricePerNight:80000,  taxesPerNight:10000 },
    ];}

    // ====== ì¶”ì²œ ê³„ì‚° ======
    function buildCombos(flights, hotels){
      const combos=[];
      for(const f of flights){
        for(const h of hotels.slice(0,10)){
          const hotelCost=(h.pricePerNight+h.taxesPerNight)* (h.nights || nightsFrom(h));
          combos.push({ flight:f, hotel:h, total:(+f.price||0)+(+hotelCost||0) });
        }
      }
      return combos;
    }
    const nightsFrom=(h)=> {
      const inD = h.checkIn? new Date(h.checkIn): null;
      const outD= h.checkOut? new Date(h.checkOut): null;
      return inD&&outD ? Math.max(1, Math.round((+outD - +inD)/86400000)) : 2;
    };

    function chooseThree(flights, hotels){
      const combos=buildCombos(flights, hotels);
      if(!combos.length) return {lowest:null, fastest:null, fewestStops:null};
      const lowest=[...combos].sort((a,b)=>a.total-b.total)[0];
      const fastest=[...combos].sort((a,b)=>a.flight.duration-b.flight.duration || a.total-b.total)[0];
      const fewestStops=[...combos].sort((a,b)=>a.flight.stops-b.flight.stops || a.total-b.total)[0];
      return {lowest, fastest, fewestStops};
    }

    // ====== ë Œë”ë§ ======
    function cardHTML(combo, tagText){
      if(!combo) return `<div class="card"><div class="text-sm text-gray-500">ê²°ê³¼ ì—†ìŒ</div></div>`;
      const f=combo.flight, h=combo.hotel;
      const hotelCost=(h.pricePerNight+h.taxesPerNight)*(h.nights||nightsFrom(h));
      const total=(+f.price||0)+(+hotelCost||0);
      return `
        <div class="card flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <div class="text-lg font-semibold">${tagText}</div>
            <span class="badge bg-gray-100 text-gray-700">${f.stops?`í™˜ìŠ¹ ${f.stops}íšŒ`:'ì§í•­'}</span>
          </div>

          <div class="pill mb-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold">í•­ê³µ (${f.airline?.name||'í•­ê³µ'})</div>
              <span class="badge bg-blue-100 text-blue-800">${minutesToHM(f.duration)}</span>
            </div>
            <div class="text-sm text-gray-600 mt-1">${f.origin} â†’ ${f.destination} Â· ${f.departDate} ${f.departTime||''}</div>
            <div class="text-sm text-gray-600">ê·€êµ­ ${f.destination} â†’ ${f.origin} Â· ${f.returnDate} ${f.returnTime||''}</div>
            <div class="mt-1 font-semibold">í•­ê³µê°€ â‚©${KRW(f.price)}</div>
          </div>

          <div class="pill mb-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold">í˜¸í…” (${h.area})</div>
              <span class="badge ${h.refundable?'bg-emerald-100 text-emerald-800':'bg-amber-100 text-amber-800'}">
                ${h.refundable?'ë¬´ë£Œì·¨ì†Œ':'í™˜ë¶ˆë¶ˆê°€'}
              </span>
            </div>
            <div class="text-sm text-gray-600 mt-1">${h.name} Â· â˜…${(+h.stars||4).toFixed(1)} Â· í‰ì  ${h.rating||'4.5'}</div>
            <div class="text-sm text-gray-600">ì²´í¬ì¸ ${h.checkIn} ~ ${h.checkOut} (${h.nights||nightsFrom(h)}ë°•)</div>
            <div class="mt-1 font-semibold">1ë°• â‚©${KRW(h.pricePerNight)} + ì„¸ê¸ˆ â‚©${KRW(h.taxesPerNight)}</div>
          </div>

          <div class="border-t pt-2">
            <div class="flex items-center justify-between text-sm text-gray-600"><span>í•­ê³µ í•©ê³„</span><span>â‚©${KRW(f.price)}</span></div>
            <div class="flex items-center justify-between text-sm text-gray-600"><span>í˜¸í…” í•©ê³„</span><span>â‚©${KRW(hotelCost)}</span></div>
            <div class="flex items-center justify-between font-bold mt-1"><span>ì´ì•¡</span><span>â‚©${KRW(total)}</span></div>
          </div>

          <button class="mt-3 px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white"
                  onclick='openPay(${JSON.stringify(JSON.stringify({f,h,total}))})'>ì˜ˆì•½ ì§„í–‰</button>
        </div>
      `;
    }

    function renderLists(flights, hotels){
      const $f=$("#flightList"), $h=$("#hotelList"), $wrap=$("#lists");
      $f.innerHTML = flights.map(f=>`
        <div class="pill">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${f.airline?.name||'í•­ê³µ'}</div>
            <span class="badge bg-gray-100 text-gray-700">${f.stops?`í™˜ìŠ¹ ${f.stops}íšŒ`:'ì§í•­'}</span>
          </div>
          <div class="text-sm text-gray-600">${f.origin}â†’${f.destination} ${f.departDate} ${f.departTime||''}</div>
          <div class="text-sm text-gray-600">ë³µê·€ ${f.destination}â†’${f.origin} ${f.returnDate} ${f.returnTime||''}</div>
          <div class="text-sm">ì†Œìš” ${minutesToHM(f.duration)} / â‚©${KRW(f.price)}</div>
        </div>`).join("");
      $h.innerHTML = hotels.map(h=>`
        <div class="pill">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${h.name} (${h.area})</div>
            <span class="badge ${h.refundable?'bg-emerald-100 text-emerald-800':'bg-amber-100 text-amber-800'}">
              ${h.refundable?'ë¬´ë£Œì·¨ì†Œ':'í™˜ë¶ˆë¶ˆê°€'}
            </span>
          </div>
          <div class="text-sm text-gray-600">â˜…${(+h.stars||4).toFixed(1)} Â· í‰ì  ${h.rating||'4.5'} Â· ë¦¬ë·° ${KRW(h.reviews||200)}</div>
          <div class="text-sm">â‚©${KRW(h.pricePerNight)} + ì„¸ê¸ˆ â‚©${KRW(h.taxesPerNight)} (ë°•ë‹¹)</div>
        </div>`).join("");
      $wrap.classList.remove("hidden");
    }

    // ====== ê²°ì œ ëª¨ë‹¬ ======
    window.openPay = (jsonStr) => {
      const {f,h,total} = JSON.parse(jsonStr);
      $("#paySummary").innerHTML = `
        <div><b>í•­ê³µ</b> ${f.airline?.name||'í•­ê³µ'} Â· ${f.origin}â†’${f.destination} (${f.departDate})</div>
        <div><b>í˜¸í…”</b> ${h.name} Â· ${h.checkIn}~${h.checkOut}</div>
        <div class="mt-1"><b>ê²°ì œê¸ˆì•¡</b> â‚©${KRW(total)}</div>
      `;
      $("#payMsg").textContent="";
      $("#payModal").classList.remove("hidden");
      $("#payModal").classList.add("flex");
      $("#btnPay").onclick = () => {
        const ok = ($("#payName").value.trim() && $("#payEmail").value.includes("@") && $("#payCard").value.replace(/[^0-9]/g,"").length>=12);
        $("#payMsg").textContent = ok ? "âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (ëª¨ì˜)" : "âš ï¸ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”";
        if(ok) setTimeout(closePay, 1000);
      };
      $("#btnCancel").onclick = closePay;
      function closePay(){
        $("#payModal").classList.add("hidden");
        $("#payModal").classList.remove("flex");
      }
    };

    // ====== API í˜¸ì¶œ with í´ë°± ======
    async function safeJSON(url){
      try{
        const r = await fetch(url, {mode:"cors"});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return { ok:true, json: await r.json() };
      }catch(e){ return { ok:false, error: String(e.message||e) }; }
    }

    async function run(){
      const API_BASE = $("#apiBase").value.trim();
      const q = $("#query").value;
      const parsed = parseNatural(q);
      $("#parsedBox").textContent = JSON.stringify({
        origin: parsed.origin, destination: parsed.destination,
        checkIn: toISO(parsed.departDate),
        checkOut: toISO(parsed.returnDate),
        nights: parsed.nights, adults: parsed.adults,
        destinationCity: parsed.destinationCity
      }, null, 2);

      $("#status").textContent = "ê²€ìƒ‰ ì¤‘â€¦";
      $("#error").classList.add("hidden");
      $("#recommend").innerHTML = "";

      // 1) API í˜¸ì¶œ (ì—†ìœ¼ë©´ mock)
      let flights = [], hotels = [];
      if(API_BASE){
        const fURL = `${API_BASE}/flights?origin=${parsed.origin}&destination=${parsed.destination}&departDate=${toISO(parsed.departDate)}&returnDate=${toISO(parsed.returnDate)}&adults=${parsed.adults}&currencyCode=KRW`;
        const hURL = `${API_BASE}/hotels?destination=${parsed.destinationCity}&checkIn=${toISO(parsed.departDate)}&checkOut=${toISO(parsed.returnDate)}&adults=${parsed.adults}`;
        const [fr, hr] = await Promise.all([safeJSON(fURL), safeJSON(hURL)]);
        if(fr.ok) flights = fr.json.flights || [];
        if(hr.ok) hotels  = hr.json.hotels  || [];
        if(!fr.ok || !hr.ok){
          $("#error").textContent = `API ì‹¤íŒ¨ â†’ Mock ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤. ${fr.ok?"":("flights: "+fr.error+" ")}${hr.ok?"":("hotels: "+hr.error)}`;
          $("#error").classList.remove("hidden");
        }
      }
      if(!flights.length) flights = mockFlights(parsed);
      if(!hotels.length)  hotels  = mockHotels(parsed);

      // 2) í›„ë³´ ë¦¬ìŠ¤íŠ¸ ë Œë” (ê²€ì¦ìš©)
      renderLists(flights, hotels);

      // 3) ì¶”ì²œ 3ì¢… ê³„ì‚°
      const {lowest, fastest, fewestStops} = chooseThree(flights, hotels);

      // 4) ì¶”ì²œ ì¹´ë“œ ë Œë”
      $("#recommend").innerHTML =
        cardHTML(lowest, "ğŸ’° ìµœì €ê°€") +
        cardHTML(fastest, "âš¡ ìµœë‹¨ì‹œê°„") +
        cardHTML(fewestStops, "â†” ìµœì €í™˜ìŠ¹");

      $("#status").textContent = "ì™„ë£Œ";
    }

    // ì´ˆê¸°ê°’/ì´ë²¤íŠ¸
    $("#apiBase").value = ""; // í”„ë¡ì‹œ ì„œë²„ê°€ ìˆìœ¼ë©´ https://.../api ë¡œ ì„¤ì •
    $("#btnSearch").addEventListener("click", run);
  </script>
</body>
</html>
