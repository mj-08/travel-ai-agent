<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>여행 AI Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white border border-gray-200 rounded-2xl p-4 shadow-sm; }
    .pill { @apply border border-gray-200 bg-gray-50 rounded-xl p-3; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    pre { background:#f8fafc; padding:8px; border-radius:8px; font-size:0.85rem; overflow:auto; }
    code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-2">여행 AI Agent</h1>
    <p class="text-gray-600 mb-6">
      AI Agent가 자연어 요청을 분석해 <b>파싱 결과</b>와 <b>API 호출 URL</b>, 그리고 
      <b>최저가 · 최단시간 · 최저환승</b> 추천을 보여줍니다.
    </p>

    <!-- 입력 -->
    <section class="card">
      <textarea id="query" rows="3" class="w-full p-3 border rounded-xl"
        placeholder="예) 인천에서 도쿄 2박 3일, 성인 2명, 10월 3일 출발 10월 5일 귀국"></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="btnSearch" class="px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">
          검색 실행
        </button>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>
    </section>

    <!-- 결과 -->
    <div id="results" class="mt-6"></div>
  </div>

  <script>
    // 🔹 반드시 본인 Vercel API 주소로 교체하세요
    const API_BASE = "https://travel-proxy.vercel.app/api";
    const $ = (sel)=>document.querySelector(sel);
    const KRW = (n)=>Number(n||0).toLocaleString('ko-KR');

    function cardHTML(combo,label){
      if(!combo) return `<div class="card">❌ 결과 없음</div>`;
      const f=combo.flight,h=combo.hotel;
      const total=f.price+(h.pricePerNight+h.taxesPerNight)*h.nights;
      return `<div class="card flex flex-col">
        <h3 class="text-lg font-semibold mb-2">${label}</h3>
        <div class="pill mb-2"><b>항공</b> ${f.airline?.name||''} ₩${KRW(f.price)}</div>
        <div class="pill mb-2"><b>호텔</b> ${h.name} ₩${KRW(h.pricePerNight)}</div>
        <div class="font-bold">총액 ₩${KRW(total)}</div>
      </div>`;
    }

    async function run(){
      $("#status").innerHTML='<span class="loader"></span> 검색 중…';
      $("#results").innerHTML="";

      try {
        // 1. AI Agent 파싱 요청
        const q=$("#query").value;
        const parseRes=await fetch(`${API_BASE}/parse`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ prompt:q })
        });
        if(!parseRes.ok) throw new Error("AI 파싱 실패");
        const parsed=await parseRes.json();

        // 2. 결과 블록 생성 (파싱 결과 표시 포함)
        const section=document.createElement("div");
        section.innerHTML=`
          <h2 class="text-xl font-bold mb-2">요청: ${q}</h2>
          <details class="mb-3" open>
            <summary class="cursor-pointer text-sm text-gray-600">파싱 결과</summary>
            <pre>${JSON.stringify(parsed,null,2)}</pre>
          </details>
          <div id="urls" class="mb-3 text-xs text-gray-700"></div>
          <div id="cards" class="grid md:grid-cols-3 gap-4"></div>
          <div id="err" class="text-red-600 mt-2 hidden"></div>`;
        $("#results").appendChild(section);

        // 3. Flights + Hotels API URL 구성
        const fURL=`${API_BASE}/flights?origin=${parsed.origin}&destination=${parsed.destination}&departDate=${parsed.departDate}&returnDate=${parsed.returnDate}&adults=${parsed.adults}`;
        const hURL=`${API_BASE}/hotels?destination=${parsed.destination}&checkIn=${parsed.departDate}&checkOut=${parsed.returnDate}&adults=${parsed.adults}`;
        section.querySelector("#urls").innerHTML=
          `<b>Flights API:</b> <code>${fURL}</code><br>
           <b>Hotels API:</b> <code>${hURL}</code>`;

        // 4. 실제 API 호출
        const [fr,hr]=await Promise.all([fetch(fURL),fetch(hURL)]);
        if(!fr.ok || !hr.ok) throw new Error("API 호출 실패");

        const flights=(await fr.json()).flights||[];
        const hotels=(await hr.json()).hotels||[];
        if(!flights.length||!hotels.length) throw new Error("검색 결과 없음");

        // 5. 추천 계산
        const combos=[]; for(const f of flights){ for(const h of hotels){
          const hotelCost=(h.pricePerNight+h.taxesPerNight)*h.nights;
          combos.push({flight:f,hotel:h,total:f.price+hotelCost});
        }}
        const lowest=[...combos].sort((a,b)=>a.total-b.total)[0];
        const fastest=[...combos].sort((a,b)=>a.flight.duration-b.flight.duration)[0];
        const fewestStops=[...combos].sort((a,b)=>a.flight.stops-b.flight.stops)[0];

        section.querySelector("#cards").innerHTML=
          cardHTML(lowest,"💰 최저가")+
          cardHTML(fastest,"⚡ 최단시간")+
          cardHTML(fewestStops,"↔ 최저환승");

        $("#status").textContent="검색 완료";
      } catch(err){
        $("#results").innerHTML=`<div class="text-red-600">⚠️ ${err.message}</div>`;
        $("#status").textContent="";
      }
    }

    $("#btnSearch").addEventListener("click",run);
  </script>
</body>
</html>
