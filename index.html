<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ AI Agent â€” ì—¬ëŸ¬ ë„ì‹œ ê²€ìƒ‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white border border-gray-200 rounded-2xl p-4 shadow-sm; }
    .pill { @apply border border-gray-200 bg-gray-50 rounded-xl p-3; }
    .badge { @apply text-xs px-2 py-0.5 rounded-full; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    pre { background:#f8fafc; padding:8px; border-radius:8px; font-size:0.85rem; overflow:auto; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-2">ì—¬í–‰ AI Agent</h1>
    <p class="text-gray-600 mb-6">ìì—°ì–´ë¡œ ì—¬ëŸ¬ ë„ì‹œ ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”. ê° ìš”ì²­ë³„ <b>íŒŒì‹± ê²°ê³¼</b> Â· <b>API URL</b> Â· <b>ì¶”ì²œ 3ì¢…</b>ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>

    <!-- ì…ë ¥ -->
    <section class="card">
      <textarea id="query" rows="5" class="w-full p-3 border rounded-xl"
        placeholder="ì˜ˆ)\nì¸ì²œì—ì„œ ë„ì¿„ 2ë°• 3ì¼, ì„±ì¸ 1ëª…\níŒŒë¦¬ì—ì„œ ë‰´ìš• 5ë°•, ì„±ì¸ 2ëª…"></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="btnSearch" class="px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">ê²€ìƒ‰ ì‹¤í–‰</button>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>
    </section>

    <!-- ê²°ê³¼ -->
    <div id="results" class="mt-6 space-y-8"></div>
  </div>

  <script>
    const API_BASE = "https://travel-proxy.vercel.app/api"; // ë³¸ì¸ API ì£¼ì†Œ
    const $ = (sel)=>document.querySelector(sel);
    const KRW = (n)=>Number(n||0).toLocaleString('ko-KR');
    const toISO=(d)=>new Date(d).toISOString().slice(0,10);

    // ê°„ë‹¨ íŒŒì„œ
    function parseNatural(text){
      const t=(text||'').trim();
      const origin=/ê¹€í¬/.test(t)?'GMP':'ICN';
      const destination=/ë‰´ìš•/.test(t)?'JFK':/íŒŒë¦¬/.test(t)?'CDG':/ë„ì¿„|í•˜ë„¤ë‹¤/.test(t)?'HND':'HND';
      const adults=(t.match(/ì„±ì¸\s*(\d+)/)?.[1]||1)|0;
      const nights=(t.match(/(\d+)\s*ë°•/)?.[1]||2)|0;
      const now=new Date();
      const departDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()+3);
      const returnDate=new Date(departDate); returnDate.setDate(departDate.getDate()+nights);
      return { raw:t, origin,destination,departDate,returnDate,nights,adults,destinationCity:destination };
    }

    // ì¡°í•© ê³„ì‚°
    function buildCombos(f,h){
      const arr=[]; for(const ff of f){ for(const hh of h){
        const hotelCost=(hh.pricePerNight+hh.taxesPerNight)*hh.nights;
        arr.push({ flight:ff, hotel:hh, total:ff.price+hotelCost });
      }} return arr;
    }
    function chooseThree(f,h){
      const c=buildCombos(f,h); if(!c.length) return {};
      return {
        lowest:[...c].sort((a,b)=>a.total-b.total)[0],
        fastest:[...c].sort((a,b)=>a.flight.duration-b.flight.duration)[0],
        fewestStops:[...c].sort((a,b)=>a.flight.stops-b.flight.stops)[0],
      };
    }

    // ì¹´ë“œ ë Œë”ë§
    function cardHTML(combo,label){
      if(!combo) return `<div class="card">âŒ ê²°ê³¼ ì—†ìŒ</div>`;
      const f=combo.flight,h=combo.hotel;
      const total=f.price+(h.pricePerNight+h.taxesPerNight)*h.nights;
      return `<div class="card flex flex-col">
        <h3 class="text-lg font-semibold mb-2">${label}</h3>
        <div class="pill mb-2"><b>í•­ê³µ</b> ${f.airline?.name||''} â‚©${KRW(f.price)}</div>
        <div class="pill mb-2"><b>í˜¸í…”</b> ${h.name} â‚©${KRW(h.pricePerNight)}</div>
        <div class="font-bold">ì´ì•¡ â‚©${KRW(total)}</div>
      </div>`;
    }

    async function fetchData(parsed){
      const fURL=`${API_BASE}/flights?origin=${parsed.origin}&destination=${parsed.destination}&departDate=${toISO(parsed.departDate)}&returnDate=${toISO(parsed.returnDate)}&adults=${parsed.adults}`;
      const hURL=`${API_BASE}/hotels?destination=${parsed.destinationCity}&checkIn=${toISO(parsed.departDate)}&checkOut=${toISO(parsed.returnDate)}&adults=${parsed.adults}`;
      const [fr,hr]=await Promise.all([fetch(fURL),fetch(hURL)]);
      if(!fr.ok || !hr.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");
      return { flights:(await fr.json()).flights||[], hotels:(await hr.json()).hotels||[], fURL, hURL };
    }

    async function run(){
      $("#status").innerHTML='<span class="loader"></span> ê²€ìƒ‰ ì¤‘â€¦';
      $("#results").innerHTML="";
      const lines=$("#query").value.split("\n").map(s=>s.trim()).filter(Boolean);
      if(!lines.length){ $("#status").textContent="ì…ë ¥ ì—†ìŒ"; return; }

      for(const line of lines){
        const parsed=parseNatural(line);
        const section=document.createElement("div");
        section.innerHTML=`
          <h2 class="text-xl font-bold mb-2">ğŸ” ìš”ì²­: ${parsed.raw}</h2>
          <details class="mb-3"><summary class="cursor-pointer text-sm text-gray-600">íŒŒì‹± ê²°ê³¼ ë³´ê¸°</summary>
            <pre>${JSON.stringify({
              origin: parsed.origin,
              destination: parsed.destination,
              checkIn: toISO(parsed.departDate),
              checkOut: toISO(parsed.returnDate),
              nights: parsed.nights,
              adults: parsed.adults
            }, null, 2)}</pre>
          </details>
          <div id="urls-${parsed.origin}-${parsed.destination}" class="mb-3 text-xs text-gray-700"></div>
          <div id="cards-${parsed.origin}-${parsed.destination}" class="grid md:grid-cols-3 gap-4"></div>
          <div id="err-${parsed.origin}-${parsed.destination}" class="text-red-600 mt-2 hidden"></div>`;
        $("#results").appendChild(section);

        try {
          const {flights,hotels,fURL,hURL}=await fetchData(parsed);
          // í˜¸ì¶œ URL í‘œì‹œ
          section.querySelector(`#urls-${parsed.origin}-${parsed.destination}`).innerHTML=
            `<b>Flights API:</b> <code>${fURL}</code><br><b>Hotels API:</b> <code>${hURL}</code>`;

          if(!flights.length||!hotels.length) throw new Error("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
          const {lowest,fastest,fewestStops}=chooseThree(flights,hotels);
          section.querySelector(`#cards-${parsed.origin}-${parsed.destination}`).innerHTML=
            cardHTML(lowest,"ğŸ’° ìµœì €ê°€")+
            cardHTML(fastest,"âš¡ ìµœë‹¨ì‹œê°„")+
            cardHTML(fewestStops,"â†” ìµœì €í™˜ìŠ¹");
        } catch(err){
          const errBox=section.querySelector(`#err-${parsed.origin}-${parsed.destination}`);
          errBox.textContent="âš ï¸ "+err.message;
          errBox.classList.remove("hidden");
        }
      }
      $("#status").textContent="ê²€ìƒ‰ ì™„ë£Œ";
    }

    $("#btnSearch").addEventListener("click",run);
  </script>
</body>
</html>
