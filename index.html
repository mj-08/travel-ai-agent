<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ AI Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white border border-gray-200 rounded-2xl p-4 shadow-sm; }
    .pill { @apply border border-gray-200 bg-gray-50 rounded-xl p-3; }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    pre { background:#f8fafc; padding:8px; border-radius:8px; font-size:0.85rem; overflow:auto; }
    code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-2">ì—¬í–‰ AI Agent</h1>
    <p class="text-gray-600 mb-6">
      AI Agentê°€ ìì—°ì–´ ìš”ì²­ì„ ë¶„ì„í•´ <b>íŒŒì‹± ê²°ê³¼</b>ì™€ <b>API í˜¸ì¶œ URL</b>, ê·¸ë¦¬ê³  
      <b>ìµœì €ê°€ Â· ìµœë‹¨ì‹œê°„ Â· ìµœì €í™˜ìŠ¹</b> ì¶”ì²œì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
    </p>

    <!-- ì…ë ¥ -->
    <section class="card">
      <textarea id="query" rows="3" class="w-full p-3 border rounded-xl"
        placeholder="ì˜ˆ) ì¸ì²œì—ì„œ ë„ì¿„ 2ë°• 3ì¼, ì„±ì¸ 2ëª…, 10ì›” 3ì¼ ì¶œë°œ 10ì›” 5ì¼ ê·€êµ­"></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button id="btnSearch" class="px-5 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">
          ê²€ìƒ‰ ì‹¤í–‰
        </button>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>
    </section>

    <!-- ê²°ê³¼ -->
    <div id="results" class="mt-6"></div>
  </div>

  <script>
    // ğŸ”¹ ë°˜ë“œì‹œ ë³¸ì¸ Vercel API ì£¼ì†Œë¡œ êµì²´í•˜ì„¸ìš”
    const API_BASE = "https://travel-proxy.vercel.app/api";
    const $ = (sel)=>document.querySelector(sel);
    const KRW = (n)=>Number(n||0).toLocaleString('ko-KR');

    function cardHTML(combo,label){
      if(!combo) return `<div class="card">âŒ ê²°ê³¼ ì—†ìŒ</div>`;
      const f=combo.flight,h=combo.hotel;
      const total=f.price+(h.pricePerNight+h.taxesPerNight)*h.nights;
      return `<div class="card flex flex-col">
        <h3 class="text-lg font-semibold mb-2">${label}</h3>
        <div class="pill mb-2"><b>í•­ê³µ</b> ${f.airline?.name||''} â‚©${KRW(f.price)}</div>
        <div class="pill mb-2"><b>í˜¸í…”</b> ${h.name} â‚©${KRW(h.pricePerNight)}</div>
        <div class="font-bold">ì´ì•¡ â‚©${KRW(total)}</div>
      </div>`;
    }

    async function run(){
      $("#status").innerHTML='<span class="loader"></span> ê²€ìƒ‰ ì¤‘â€¦';
      $("#results").innerHTML="";

      try {
        // 1. AI Agent íŒŒì‹± ìš”ì²­
        const q=$("#query").value;
        const parseRes=await fetch(`${API_BASE}/parse`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ prompt:q })
        });
        if(!parseRes.ok) throw new Error("AI íŒŒì‹± ì‹¤íŒ¨");
        const parsed=await parseRes.json();

        // 2. ê²°ê³¼ ë¸”ë¡ ìƒì„± (íŒŒì‹± ê²°ê³¼ í‘œì‹œ í¬í•¨)
        const section=document.createElement("div");
        section.innerHTML=`
          <h2 class="text-xl font-bold mb-2">ìš”ì²­: ${q}</h2>
          <details class="mb-3" open>
            <summary class="cursor-pointer text-sm text-gray-600">íŒŒì‹± ê²°ê³¼</summary>
            <pre>${JSON.stringify(parsed,null,2)}</pre>
          </details>
          <div id="urls" class="mb-3 text-xs text-gray-700"></div>
          <div id="cards" class="grid md:grid-cols-3 gap-4"></div>
          <div id="err" class="text-red-600 mt-2 hidden"></div>`;
        $("#results").appendChild(section);

        // 3. Flights + Hotels API URL êµ¬ì„±
        const fURL=`${API_BASE}/flights?origin=${parsed.origin}&destination=${parsed.destination}&departDate=${parsed.departDate}&returnDate=${parsed.returnDate}&adults=${parsed.adults}`;
        const hURL=`${API_BASE}/hotels?destination=${parsed.destination}&checkIn=${parsed.departDate}&checkOut=${parsed.returnDate}&adults=${parsed.adults}`;
        section.querySelector("#urls").innerHTML=
          `<b>Flights API:</b> <code>${fURL}</code><br>
           <b>Hotels API:</b> <code>${hURL}</code>`;

        // 4. ì‹¤ì œ API í˜¸ì¶œ
        const [fr,hr]=await Promise.all([fetch(fURL),fetch(hURL)]);
        if(!fr.ok || !hr.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");

        const flights=(await fr.json()).flights||[];
        const hotels=(await hr.json()).hotels||[];
        if(!flights.length||!hotels.length) throw new Error("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");

        // 5. ì¶”ì²œ ê³„ì‚°
        const combos=[]; for(const f of flights){ for(const h of hotels){
          const hotelCost=(h.pricePerNight+h.taxesPerNight)*h.nights;
          combos.push({flight:f,hotel:h,total:f.price+hotelCost});
        }}
        const lowest=[...combos].sort((a,b)=>a.total-b.total)[0];
        const fastest=[...combos].sort((a,b)=>a.flight.duration-b.flight.duration)[0];
        const fewestStops=[...combos].sort((a,b)=>a.flight.stops-b.flight.stops)[0];

        section.querySelector("#cards").innerHTML=
          cardHTML(lowest,"ğŸ’° ìµœì €ê°€")+
          cardHTML(fastest,"âš¡ ìµœë‹¨ì‹œê°„")+
          cardHTML(fewestStops,"â†” ìµœì €í™˜ìŠ¹");

        $("#status").textContent="ê²€ìƒ‰ ì™„ë£Œ";
      } catch(err){
        $("#results").innerHTML=`<div class="text-red-600">âš ï¸ ${err.message}</div>`;
        $("#status").textContent="";
      }
    }

    $("#btnSearch").addEventListener("click",run);
  </script>
</body>
</html>
